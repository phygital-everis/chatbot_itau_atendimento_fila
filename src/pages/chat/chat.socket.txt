import { Component, ViewChild } from '@angular/core';
import { NavController, NavParams, ToastController, Content } from 'ionic-angular';
import { Socket } from 'ng-socket-io';
import { Observable } from 'rxjs/Observable';


@Component({
    selector: 'page-chat',
    templateUrl: 'chat.html',
})
export class ChatPage {
    @ViewChild(Content) contentArea: Content;
    public nickname: string
    public messages = []
    public message: string
    public answer: string = ''

    constructor(
        public navCtrl: NavController,
        public navParams: NavParams,
        private socket: Socket,
        private toastCtrl: ToastController
    ) {

        this.nickname = this.navParams.get('nickname');
        this.socket.emit('welcome');

        this.getMessages().subscribe(message => {
            this.messages.push(message);
            setTimeout(() => {
                this.contentArea.scrollToBottom();
            }, 500);

        });



        this.getUsers().subscribe(data => {
            let user = data['user'];
            if (data['event'] === 'left') {
                this.showToast('AtÃ© logo : ' + user);
            } else {
                this.showToast('Seja Bem vindo : ' + user);
            }
        });
    }

    sendMessage() {
        this.socket.emit('add-message', { text: this.message });
        this.message = '';
    }

    getMessages() {
        let observable = new Observable(observer => {
            this.socket.on('message', (data) => {
                observer.next(data);
            });
        })
        return observable;
    }

    getUsers() {
        let observable = new Observable(observer => {
            this.socket.on('users-changed', (data) => {
                observer.next(data);
            });
        });
        return observable;
    }

    ionViewWillLeave() {
        this.socket.disconnect();
    }

    showToast(msg) {
        let toast = this.toastCtrl.create({
            message: msg,
            duration: 2000
        });
        toast.present();
    }


}
